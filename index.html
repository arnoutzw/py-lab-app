<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyLab — Browser Python Notebook</title>
    <meta name="description" content="A Jupyter-like notebook running Python with NumPy, SciPy, and Matplotlib entirely in the browser.">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link id="manifest-link" rel="manifest" href="">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- CodeMirror 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/comment/comment.min.js"></script>

    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    mono: ['JetBrains Mono', 'monospace']
                }
            }
        }
    }
    </script>

    <style>
        /* ── Scrollbars ── */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* ── CodeMirror Theme ── */
        .CodeMirror {
            background: #18181b !important;
            color: #f4f4f5 !important;
            font-family: 'JetBrains Mono', monospace !important;
            font-size: 14px;
            line-height: 1.65;
            height: auto;
            border: none;
            padding: 4px 0;
        }
        .CodeMirror-gutters {
            background: #18181b !important;
            border-right: 1px solid #27272a !important;
        }
        .CodeMirror-linenumber {
            color: #52525b !important;
            font-size: 12px;
            padding: 0 8px 0 12px !important;
        }
        .CodeMirror-cursor { border-left: 2px solid #f59e0b !important; }
        .CodeMirror-selected { background: rgba(245,158,11,0.12) !important; }
        .CodeMirror-focused .CodeMirror-selected { background: rgba(245,158,11,0.18) !important; }
        .CodeMirror-activeline-background { background: rgba(39,39,42,0.5) !important; }
        .CodeMirror-matchingbracket { color: #fbbf24 !important; outline: 1px solid #fbbf2460; background: rgba(251,191,36,0.1); }

        /* Syntax tokens */
        .cm-s-default .cm-keyword { color: #f59e0b !important; font-weight: 500; }
        .cm-s-default .cm-def { color: #60a5fa !important; }
        .cm-s-default .cm-variable { color: #f4f4f5 !important; }
        .cm-s-default .cm-variable-2 { color: #e2e8f0 !important; }
        .cm-s-default .cm-variable-3 { color: #c084fc !important; }
        .cm-s-default .cm-property { color: #f4f4f5 !important; }
        .cm-s-default .cm-operator { color: #fbbf24 !important; }
        .cm-s-default .cm-number { color: #34d399 !important; }
        .cm-s-default .cm-string { color: #4ade80 !important; }
        .cm-s-default .cm-string-2 { color: #86efac !important; }
        .cm-s-default .cm-comment { color: #71717a !important; font-style: italic; }
        .cm-s-default .cm-builtin { color: #c084fc !important; }
        .cm-s-default .cm-meta { color: #a1a1aa !important; }
        .cm-s-default .cm-atom { color: #f472b6 !important; }
        .cm-s-default .cm-error { color: #f87171 !important; }

        /* ── Animations ── */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 30px rgba(245,158,11,0.15); }
            50%      { box-shadow: 0 0 60px rgba(245,158,11,0.35); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .anim-fade-in { animation: fadeInUp 0.3s ease-out both; }
        .anim-glow    { animation: pulseGlow 2s ease-in-out infinite; }
        .anim-spin    { animation: spin 1s linear infinite; }

        /* ── Cell Add Buttons ── */
        .add-row { opacity: 0; transition: opacity 0.2s; height: 28px; }
        .add-row:hover, .add-row:focus-within { opacity: 1; }

        /* ── Markdown Rendered Prose ── */
        .md-rendered h1 { font-size: 1.5rem; font-weight: 700; color: #f59e0b; margin: 0.75rem 0 0.5rem; }
        .md-rendered h2 { font-size: 1.25rem; font-weight: 700; color: #f4f4f5; margin: 0.6rem 0 0.4rem; }
        .md-rendered h3 { font-size: 1.1rem; font-weight: 600; color: #f4f4f5; margin: 0.5rem 0 0.3rem; }
        .md-rendered p { color: #d4d4d8; margin: 0.4rem 0; line-height: 1.7; }
        .md-rendered a { color: #f59e0b; text-decoration: underline; }
        .md-rendered code { background: #27272a; color: #fbbf24; padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; }
        .md-rendered pre { background: #27272a; border: 1px solid #3f3f46; border-radius: 8px; padding: 12px 16px; overflow-x: auto; margin: 0.5rem 0; }
        .md-rendered pre code { background: none; padding: 0; }
        .md-rendered ul, .md-rendered ol { padding-left: 1.5rem; color: #d4d4d8; margin: 0.4rem 0; }
        .md-rendered li { margin: 0.2rem 0; }
        .md-rendered blockquote { border-left: 3px solid #f59e0b; padding-left: 1rem; color: #a1a1aa; margin: 0.5rem 0; }
        .md-rendered hr { border: none; border-top: 1px solid #3f3f46; margin: 1rem 0; }
        .md-rendered img { max-width: 100%; border-radius: 8px; margin: 0.5rem 0; }
        .md-rendered table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; }
        .md-rendered th, .md-rendered td { border: 1px solid #3f3f46; padding: 6px 12px; text-align: left; }
        .md-rendered th { background: #27272a; color: #f4f4f5; font-weight: 600; }
        .md-rendered td { color: #d4d4d8; }

        /* ── Cheat Sheet Panel ── */
        #cheatsheet-panel.open { transform: translateX(0); }
        .cs-heading {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #f59e0b;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid #27272a;
            margin-bottom: 0.5rem;
        }
        .cs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .cs-table thead th {
            text-align: left;
            font-weight: 600;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #71717a;
            padding: 0.3rem 0.5rem;
            border-bottom: 1px solid #27272a;
        }
        .cs-table tbody td {
            padding: 0.35rem 0.5rem;
            border-bottom: 1px solid #1e1e22;
            vertical-align: top;
            color: #d4d4d8;
        }
        .cs-table tbody tr:hover td { background: rgba(245, 158, 11, 0.04); }
        .cs-table code {
            background: #27272a;
            color: #fbbf24;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.72rem;
            white-space: nowrap;
        }
        .cs-table thead th:first-child,
        .cs-table tbody td:first-child { width: 45%; }
        .cs-note {
            color: #71717a;
            font-size: 0.6rem;
            font-style: italic;
        }
        .cs-section.hidden { display: none; }

        /* ── AI Assistant Panel ── */
        #assistant-panel.open { transform: translateX(0); }
        .ai-msg {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.82rem;
            line-height: 1.6;
            max-width: 100%;
            overflow-wrap: break-word;
        }
        .ai-msg-user {
            background: #292524;
            border: 1px solid #3f3f46;
            color: #e2e8f0;
        }
        .ai-msg-assistant {
            background: #1c1917;
            border: 1px solid #27272a;
            color: #d4d4d8;
        }
        .ai-msg-assistant pre {
            background: #18181b;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            padding: 0.6rem 0.75rem;
            overflow-x: auto;
            margin: 0.4rem 0;
            position: relative;
        }
        .ai-msg-assistant code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            color: #fbbf24;
        }
        .ai-msg-assistant pre code {
            color: #e2e8f0;
            background: none;
            padding: 0;
        }
        .ai-msg-assistant p { margin: 0.3rem 0; }
        .ai-msg-assistant ul, .ai-msg-assistant ol { padding-left: 1.2rem; margin: 0.3rem 0; }
        .ai-msg-assistant li { margin: 0.15rem 0; }
        .ai-msg-assistant h1, .ai-msg-assistant h2, .ai-msg-assistant h3 {
            font-weight: 600; color: #f4f4f5; margin: 0.5rem 0 0.25rem;
        }
        .ai-msg-assistant h1 { font-size: 1.05rem; }
        .ai-msg-assistant h2 { font-size: 0.95rem; }
        .ai-msg-assistant h3 { font-size: 0.88rem; }
        .ai-msg-assistant blockquote {
            border-left: 2px solid #f59e0b;
            padding-left: 0.75rem;
            color: #a1a1aa;
            margin: 0.3rem 0;
        }
        .ai-code-insert-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #27272a;
            border: 1px solid #3f3f46;
            color: #a1a1aa;
            font-size: 0.6rem;
            font-family: 'JetBrains Mono', monospace;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .ai-code-insert-btn:hover { background: #f59e0b; color: #18181b; border-color: #f59e0b; }
        @keyframes aiPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .ai-typing-dot { animation: aiPulse 1.2s ease-in-out infinite; }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* ── Misc ── */
        .cell-output-scroll { max-height: 500px; overflow-y: auto; }
        body { padding-bottom: 44px; }
    </style>
</head>

<body class="bg-zinc-950 text-zinc-100 font-sans min-h-screen">

<!-- ══════════════ LOADING SCREEN ══════════════ -->
<div id="loading-screen" class="fixed inset-0 z-[100] bg-zinc-950 flex items-center justify-center">
    <div class="text-center">
        <div class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-zinc-900 border border-zinc-700 flex items-center justify-center anim-glow">
            <span class="text-amber-500 font-mono font-bold text-5xl select-none">λ</span>
        </div>
        <h1 class="font-mono font-bold text-2xl text-amber-500 mb-1">PyLab</h1>
        <p class="text-zinc-500 text-sm mb-8">Browser-native Python notebook</p>
        <div class="w-72 h-1.5 bg-zinc-800 rounded-full overflow-hidden mx-auto mb-4">
            <div id="progress-fill" class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <p id="loading-status" class="text-xs font-mono text-zinc-500">Initializing&hellip;</p>
        <p id="loading-error" class="text-xs font-mono text-red-400 mt-3 hidden"></p>
    </div>
</div>

<!-- ══════════════ HEADER ══════════════ -->
<header class="sticky top-0 z-40 bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800">
    <div class="max-w-6xl mx-auto px-4 py-2.5 flex items-center justify-between gap-4">
        <!-- Left: branding -->
        <div class="flex items-center gap-3 shrink-0">
            <div class="flex gap-1.5">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
            </div>
            <span class="text-amber-500 font-mono font-bold text-lg leading-none select-none">λ</span>
            <span class="font-mono font-bold text-zinc-100 text-sm hidden sm:inline">PyLab</span>
            <span class="text-xs px-2 py-0.5 bg-amber-500/10 text-amber-400 rounded font-mono hidden sm:inline">PWA</span>
        </div>
        <!-- Right: toolbar -->
        <div class="flex items-center gap-1.5 flex-wrap justify-end">
            <button onclick="runAllCells()" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5" title="Run All Cells">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                Run All
            </button>
            <button onclick="restartKernel()" class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors" title="Restart Kernel">↺ Restart</button>
            <button onclick="clearAllOutputs()" class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors" title="Clear Outputs">Clear</button>
            <div class="w-px h-5 bg-zinc-700 mx-1 hidden sm:block"></div>
            <button onclick="downloadNotebook()" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 px-2 py-1.5 rounded-lg transition-colors" title="Download Notebook">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </button>
            <button onclick="document.getElementById('file-input').click()" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 px-2 py-1.5 rounded-lg transition-colors" title="Load Notebook">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </button>
            <div class="w-px h-5 bg-zinc-700 mx-1 hidden sm:block"></div>
            <button onclick="toggleCheatSheet()" id="cheatsheet-btn" class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1.5" title="MATLAB → Python Cheat Sheet">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                <span class="hidden sm:inline">Cheat Sheet</span>
            </button>
            <button onclick="toggleAssistant()" id="assistant-btn" class="bg-gradient-to-r from-amber-600 to-orange-500 hover:from-amber-500 hover:to-orange-400 text-white text-xs font-mono font-bold px-3 py-1.5 rounded-lg transition-all flex items-center gap-1.5 shadow-sm shadow-amber-500/20" title="AI Coding Assistant">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/><circle cx="9" cy="14" r="1"/><circle cx="15" cy="14" r="1"/></svg>
                <span class="hidden sm:inline">AI</span>
            </button>
        </div>
    </div>
</header>

<!-- ══════════════ NOTEBOOK ══════════════ -->
<main id="notebook" class="max-w-5xl mx-auto px-4 py-6"></main>

<!-- ══════════════ CHEAT SHEET PANEL ══════════════ -->
<div id="cheatsheet-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleCheatSheet()"></div>
<aside id="cheatsheet-panel" class="fixed top-0 right-0 h-full w-[420px] max-w-[90vw] bg-zinc-900 border-l border-zinc-800 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <!-- Panel Header -->
    <div class="flex items-center justify-between px-5 py-3 border-b border-zinc-800 shrink-0">
        <div class="flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
            <h2 class="font-mono font-bold text-sm text-zinc-100">MATLAB → Python</h2>
            <span class="text-xs px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded font-mono">NumPy / SciPy</span>
        </div>
        <button onclick="toggleCheatSheet()" class="text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
    </div>

    <!-- Search -->
    <div class="px-5 py-3 border-b border-zinc-800 shrink-0">
        <input id="cheatsheet-search" type="text" placeholder="Search commands..." oninput="filterCheatSheet(this.value)"
            class="w-full bg-zinc-800 border border-zinc-700 text-zinc-200 text-xs font-mono px-3 py-2 rounded-lg outline-none focus:border-amber-500/50 placeholder-zinc-600 transition-colors">
    </div>

    <!-- Cheat Sheet Content -->
    <div id="cheatsheet-content" class="flex-1 overflow-y-auto px-5 py-4 space-y-5">

        <!-- Basic Operations -->
        <div class="cs-section" data-section="basic">
            <h3 class="cs-heading">Basic Operations</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (NumPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>a = [1 2 3]</code></td><td><code>a = np.array([1, 2, 3])</code></td></tr>
                    <tr><td><code>a(1)</code></td><td><code>a[0]</code> <span class="cs-note">0-indexed</span></td></tr>
                    <tr><td><code>a(end)</code></td><td><code>a[-1]</code></td></tr>
                    <tr><td><code>a(2:4)</code></td><td><code>a[1:4]</code></td></tr>
                    <tr><td><code>a'</code></td><td><code>a.T</code></td></tr>
                    <tr><td><code>length(a)</code></td><td><code>len(a)</code> or <code>a.size</code></td></tr>
                    <tr><td><code>size(a)</code></td><td><code>a.shape</code></td></tr>
                    <tr><td><code>numel(a)</code></td><td><code>a.size</code></td></tr>
                    <tr><td><code>ndims(a)</code></td><td><code>a.ndim</code></td></tr>
                    <tr><td><code>class(a)</code></td><td><code>a.dtype</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Matrix Creation -->
        <div class="cs-section" data-section="creation">
            <h3 class="cs-heading">Matrix / Array Creation</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (NumPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>zeros(3,4)</code></td><td><code>np.zeros((3, 4))</code></td></tr>
                    <tr><td><code>ones(3,4)</code></td><td><code>np.ones((3, 4))</code></td></tr>
                    <tr><td><code>eye(3)</code></td><td><code>np.eye(3)</code></td></tr>
                    <tr><td><code>rand(3,4)</code></td><td><code>np.random.rand(3, 4)</code></td></tr>
                    <tr><td><code>randn(3,4)</code></td><td><code>np.random.randn(3, 4)</code></td></tr>
                    <tr><td><code>linspace(0,1,100)</code></td><td><code>np.linspace(0, 1, 100)</code></td></tr>
                    <tr><td><code>0:0.1:1</code></td><td><code>np.arange(0, 1.1, 0.1)</code></td></tr>
                    <tr><td><code>diag([1 2 3])</code></td><td><code>np.diag([1, 2, 3])</code></td></tr>
                    <tr><td><code>[a; b]</code></td><td><code>np.vstack([a, b])</code></td></tr>
                    <tr><td><code>[a, b]</code></td><td><code>np.hstack([a, b])</code></td></tr>
                    <tr><td><code>repmat(a,2,3)</code></td><td><code>np.tile(a, (2, 3))</code></td></tr>
                    <tr><td><code>meshgrid(x,y)</code></td><td><code>np.meshgrid(x, y)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Arithmetic & Element-wise -->
        <div class="cs-section" data-section="arithmetic">
            <h3 class="cs-heading">Arithmetic & Element-wise Ops</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (NumPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>a * b</code> <span class="cs-note">matrix</span></td><td><code>a @ b</code> or <code>np.dot(a, b)</code></td></tr>
                    <tr><td><code>a .* b</code></td><td><code>a * b</code></td></tr>
                    <tr><td><code>a ./ b</code></td><td><code>a / b</code></td></tr>
                    <tr><td><code>a .^ 2</code></td><td><code>a ** 2</code></td></tr>
                    <tr><td><code>a \ b</code></td><td><code>np.linalg.solve(a, b)</code></td></tr>
                    <tr><td><code>a / b</code> <span class="cs-note">mrdivide</span></td><td><code>a @ np.linalg.inv(b)</code></td></tr>
                    <tr><td><code>sqrt(a)</code></td><td><code>np.sqrt(a)</code></td></tr>
                    <tr><td><code>abs(a)</code></td><td><code>np.abs(a)</code></td></tr>
                    <tr><td><code>exp(a)</code></td><td><code>np.exp(a)</code></td></tr>
                    <tr><td><code>log(a)</code></td><td><code>np.log(a)</code></td></tr>
                    <tr><td><code>log10(a)</code></td><td><code>np.log10(a)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Linear Algebra -->
        <div class="cs-section" data-section="linalg">
            <h3 class="cs-heading">Linear Algebra</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (NumPy / SciPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>inv(A)</code></td><td><code>np.linalg.inv(A)</code></td></tr>
                    <tr><td><code>det(A)</code></td><td><code>np.linalg.det(A)</code></td></tr>
                    <tr><td><code>eig(A)</code></td><td><code>np.linalg.eig(A)</code></td></tr>
                    <tr><td><code>[U,S,V] = svd(A)</code></td><td><code>U, S, Vt = np.linalg.svd(A)</code></td></tr>
                    <tr><td><code>rank(A)</code></td><td><code>np.linalg.matrix_rank(A)</code></td></tr>
                    <tr><td><code>norm(A)</code></td><td><code>np.linalg.norm(A)</code></td></tr>
                    <tr><td><code>trace(A)</code></td><td><code>np.trace(A)</code></td></tr>
                    <tr><td><code>chol(A)</code></td><td><code>np.linalg.cholesky(A)</code></td></tr>
                    <tr><td><code>[Q,R] = qr(A)</code></td><td><code>Q, R = np.linalg.qr(A)</code></td></tr>
                    <tr><td><code>[L,U,P] = lu(A)</code></td><td><code>P, L, U = scipy.linalg.lu(A)</code></td></tr>
                    <tr><td><code>pinv(A)</code></td><td><code>np.linalg.pinv(A)</code></td></tr>
                    <tr><td><code>cross(a,b)</code></td><td><code>np.cross(a, b)</code></td></tr>
                    <tr><td><code>dot(a,b)</code></td><td><code>np.dot(a, b)</code></td></tr>
                    <tr><td><code>kron(A,B)</code></td><td><code>np.kron(A, B)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Statistics -->
        <div class="cs-section" data-section="stats">
            <h3 class="cs-heading">Statistics & Aggregation</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (NumPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>sum(a)</code></td><td><code>np.sum(a)</code> or <code>a.sum()</code></td></tr>
                    <tr><td><code>mean(a)</code></td><td><code>np.mean(a)</code></td></tr>
                    <tr><td><code>median(a)</code></td><td><code>np.median(a)</code></td></tr>
                    <tr><td><code>std(a)</code></td><td><code>np.std(a, ddof=1)</code></td></tr>
                    <tr><td><code>var(a)</code></td><td><code>np.var(a, ddof=1)</code></td></tr>
                    <tr><td><code>max(a)</code></td><td><code>np.max(a)</code> or <code>a.max()</code></td></tr>
                    <tr><td><code>min(a)</code></td><td><code>np.min(a)</code> or <code>a.min()</code></td></tr>
                    <tr><td><code>[v, i] = max(a)</code></td><td><code>v = a.max(); i = a.argmax()</code></td></tr>
                    <tr><td><code>cumsum(a)</code></td><td><code>np.cumsum(a)</code></td></tr>
                    <tr><td><code>cumprod(a)</code></td><td><code>np.cumprod(a)</code></td></tr>
                    <tr><td><code>sort(a)</code></td><td><code>np.sort(a)</code></td></tr>
                    <tr><td><code>sortrows(A,col)</code></td><td><code>A[A[:,col].argsort()]</code></td></tr>
                    <tr><td><code>unique(a)</code></td><td><code>np.unique(a)</code></td></tr>
                    <tr><td><code>hist(a,n)</code></td><td><code>np.histogram(a, bins=n)</code></td></tr>
                    <tr><td><code>corrcoef(a,b)</code></td><td><code>np.corrcoef(a, b)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Indexing & Reshaping -->
        <div class="cs-section" data-section="indexing">
            <h3 class="cs-heading">Indexing & Reshaping</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (NumPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>A(2,:)</code></td><td><code>A[1, :]</code></td></tr>
                    <tr><td><code>A(:,3)</code></td><td><code>A[:, 2]</code></td></tr>
                    <tr><td><code>A(1:3, 2:4)</code></td><td><code>A[0:3, 1:4]</code></td></tr>
                    <tr><td><code>A(A > 5)</code></td><td><code>A[A > 5]</code></td></tr>
                    <tr><td><code>find(A > 5)</code></td><td><code>np.where(A > 5)</code></td></tr>
                    <tr><td><code>reshape(A,m,n)</code></td><td><code>A.reshape(m, n)</code></td></tr>
                    <tr><td><code>A(:)</code></td><td><code>A.flatten()</code> or <code>A.ravel()</code></td></tr>
                    <tr><td><code>squeeze(A)</code></td><td><code>A.squeeze()</code></td></tr>
                    <tr><td><code>flipud(A)</code></td><td><code>np.flipud(A)</code></td></tr>
                    <tr><td><code>fliplr(A)</code></td><td><code>np.fliplr(A)</code></td></tr>
                    <tr><td><code>rot90(A)</code></td><td><code>np.rot90(A)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Signal Processing -->
        <div class="cs-section" data-section="signal">
            <h3 class="cs-heading">Signal Processing (SciPy)</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (SciPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>fft(x)</code></td><td><code>np.fft.fft(x)</code></td></tr>
                    <tr><td><code>ifft(X)</code></td><td><code>np.fft.ifft(X)</code></td></tr>
                    <tr><td><code>fftshift(X)</code></td><td><code>np.fft.fftshift(X)</code></td></tr>
                    <tr><td><code>conv(a,b)</code></td><td><code>np.convolve(a, b)</code></td></tr>
                    <tr><td><code>filter(b,a,x)</code></td><td><code>scipy.signal.lfilter(b,a,x)</code></td></tr>
                    <tr><td><code>filtfilt(b,a,x)</code></td><td><code>scipy.signal.filtfilt(b,a,x)</code></td></tr>
                    <tr><td><code>butter(n,Wn)</code></td><td><code>scipy.signal.butter(n,Wn)</code></td></tr>
                    <tr><td><code>[pxx,f]=pwelch(x)</code></td><td><code>f,pxx=scipy.signal.welch(x)</code></td></tr>
                    <tr><td><code>spectrogram(x)</code></td><td><code>scipy.signal.spectrogram(x)</code></td></tr>
                    <tr><td><code>resample(x,n)</code></td><td><code>scipy.signal.resample(x,n)</code></td></tr>
                    <tr><td><code>decimate(x,r)</code></td><td><code>scipy.signal.decimate(x,r)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Plotting -->
        <div class="cs-section" data-section="plotting">
            <h3 class="cs-heading">Plotting (Matplotlib)</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (Matplotlib)</th></tr></thead>
                <tbody>
                    <tr><td><code>figure</code></td><td><code>plt.figure()</code></td></tr>
                    <tr><td><code>plot(x,y)</code></td><td><code>plt.plot(x, y)</code></td></tr>
                    <tr><td><code>subplot(2,1,1)</code></td><td><code>plt.subplot(2, 1, 1)</code></td></tr>
                    <tr><td><code>fig, ax = subplots</code></td><td><code>fig, ax = plt.subplots()</code></td></tr>
                    <tr><td><code>scatter(x,y)</code></td><td><code>plt.scatter(x, y)</code></td></tr>
                    <tr><td><code>bar(x,y)</code></td><td><code>plt.bar(x, y)</code></td></tr>
                    <tr><td><code>histogram(x)</code></td><td><code>plt.hist(x)</code></td></tr>
                    <tr><td><code>imagesc(A)</code></td><td><code>plt.imshow(A)</code></td></tr>
                    <tr><td><code>contour(X,Y,Z)</code></td><td><code>plt.contour(X, Y, Z)</code></td></tr>
                    <tr><td><code>xlabel('x')</code></td><td><code>plt.xlabel('x')</code></td></tr>
                    <tr><td><code>title('t')</code></td><td><code>plt.title('t')</code></td></tr>
                    <tr><td><code>legend('a','b')</code></td><td><code>plt.legend(['a','b'])</code></td></tr>
                    <tr><td><code>grid on</code></td><td><code>plt.grid(True)</code></td></tr>
                    <tr><td><code>hold on</code></td><td><span class="cs-note">default behavior</span></td></tr>
                    <tr><td><code>colorbar</code></td><td><code>plt.colorbar()</code></td></tr>
                    <tr><td><code>xlim([0 10])</code></td><td><code>plt.xlim(0, 10)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Interpolation & Integration -->
        <div class="cs-section" data-section="interp">
            <h3 class="cs-heading">Interpolation & Integration</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (SciPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>interp1(x,y,xq)</code></td><td><code>scipy.interpolate.interp1d(x,y)(xq)</code></td></tr>
                    <tr><td><code>interp2(X,Y,Z,...)</code></td><td><code>scipy.interpolate.interp2d(...)</code></td></tr>
                    <tr><td><code>spline(x,y,xq)</code></td><td><code>scipy.interpolate.CubicSpline(x,y)(xq)</code></td></tr>
                    <tr><td><code>trapz(y,x)</code></td><td><code>np.trapz(y, x)</code></td></tr>
                    <tr><td><code>integral(@f,a,b)</code></td><td><code>scipy.integrate.quad(f, a, b)</code></td></tr>
                    <tr><td><code>ode45(@f,tspan,y0)</code></td><td><code>scipy.integrate.solve_ivp(f,tspan,y0)</code></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Optimization -->
        <div class="cs-section" data-section="optim">
            <h3 class="cs-heading">Optimization & Root Finding</h3>
            <table class="cs-table">
                <thead><tr><th>MATLAB</th><th>Python (SciPy)</th></tr></thead>
                <tbody>
                    <tr><td><code>fminsearch(f,x0)</code></td><td><code>scipy.optimize.minimize(f,x0)</code></td></tr>
                    <tr><td><code>fminunc(f,x0)</code></td><td><code>scipy.optimize.minimize(f,x0)</code></td></tr>
                    <tr><td><code>fzero(f,x0)</code></td><td><code>scipy.optimize.brentq(f,a,b)</code></td></tr>
                    <tr><td><code>fsolve(f,x0)</code></td><td><code>scipy.optimize.fsolve(f,x0)</code></td></tr>
                    <tr><td><code>lsqcurvefit(f,...)</code></td><td><code>scipy.optimize.curve_fit(f,...)</code></td></tr>
                    <tr><td><code>polyfit(x,y,n)</code></td><td><code>np.polyfit(x, y, n)</code></td></tr>
                    <tr><td><code>polyval(p,x)</code></td><td><code>np.polyval(p, x)</code></td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- Panel Footer -->
    <div class="px-5 py-2.5 border-t border-zinc-800 shrink-0">
        <p class="text-xs text-zinc-600 font-mono text-center">import numpy as np &middot; import scipy &middot; import matplotlib.pyplot as plt</p>
    </div>
</aside>

<!-- ══════════════ AI ASSISTANT PANEL ══════════════ -->
<div id="assistant-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleAssistant()"></div>
<aside id="assistant-panel" class="fixed top-0 right-0 h-full w-[480px] max-w-[92vw] bg-zinc-900 border-l border-zinc-800 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <!-- Panel Header -->
    <div class="flex items-center justify-between px-5 py-3 border-b border-zinc-800 shrink-0">
        <div class="flex items-center gap-2">
            <div id="ai-provider-icon" class="w-6 h-6 rounded-md bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/><circle cx="9" cy="14" r="1"/><circle cx="15" cy="14" r="1"/></svg>
            </div>
            <h2 class="font-mono font-bold text-sm text-zinc-100">AI Assistant</h2>
            <select id="ai-provider-select" onchange="switchAiProvider(this.value)"
                class="bg-zinc-800 border border-zinc-700 text-amber-400 text-xs font-mono px-2 py-0.5 rounded cursor-pointer outline-none hover:border-zinc-600 transition-colors">
                <option value="claude">Claude</option>
                <option value="gemini">Gemini</option>
            </select>
        </div>
        <div class="flex items-center gap-1">
            <button onclick="clearAssistantChat()" class="text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors text-xs font-mono" title="Clear conversation">Clear</button>
            <button onclick="toggleAssistantSettings()" id="ai-settings-toggle" class="text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="API key settings">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            </button>
            <button onclick="toggleAssistant()" class="text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
    </div>

    <!-- API Key Settings (collapsible) -->
    <div id="ai-settings" class="px-5 py-3 border-b border-zinc-800 shrink-0 hidden space-y-3">
        <!-- Claude API Key -->
        <div id="ai-key-claude">
            <label class="text-xs font-mono text-zinc-500 block mb-1.5">Anthropic API Key <span class="text-amber-500/60">(Claude)</span></label>
            <div class="flex gap-2">
                <input id="ai-api-key-claude" type="password" placeholder="sk-ant-..." oninput="saveProviderKey('claude', this.value)" onpaste="setTimeout(()=>saveProviderKey('claude', this.value),0)" onchange="saveProviderKey('claude', this.value)" autocomplete="off"
                    class="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 text-xs font-mono px-3 py-2 rounded-lg outline-none focus:border-amber-500/50 placeholder-zinc-600 transition-colors">
                <button onclick="toggleKeyVisibility('ai-api-key-claude')" class="text-zinc-500 hover:text-zinc-300 bg-zinc-800 border border-zinc-700 px-2 rounded-lg transition-colors" title="Show/hide key">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </div>
        <!-- Gemini API Key -->
        <div id="ai-key-gemini">
            <label class="text-xs font-mono text-zinc-500 block mb-1.5">Google API Key <span class="text-blue-400/60">(Gemini)</span></label>
            <div class="flex gap-2">
                <input id="ai-api-key-gemini" type="password" placeholder="AIza..." oninput="saveProviderKey('gemini', this.value)" onpaste="setTimeout(()=>saveProviderKey('gemini', this.value),0)" onchange="saveProviderKey('gemini', this.value)" autocomplete="off"
                    class="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 text-xs font-mono px-3 py-2 rounded-lg outline-none focus:border-blue-500/50 placeholder-zinc-600 transition-colors">
                <button onclick="toggleKeyVisibility('ai-api-key-gemini')" class="text-zinc-500 hover:text-zinc-300 bg-zinc-800 border border-zinc-700 px-2 rounded-lg transition-colors" title="Show/hide key">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </div>
        <p class="text-xs text-zinc-600">Keys are stored locally in your browser. Never sent anywhere except their respective API.</p>
    </div>

    <!-- Messages -->
    <div id="ai-messages" class="flex-1 overflow-y-auto px-5 py-4 space-y-3">
        <!-- Welcome message -->
        <div class="text-center py-8">
            <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/20 flex items-center justify-center">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/><circle cx="9" cy="14" r="1"/><circle cx="15" cy="14" r="1"/></svg>
            </div>
            <p class="text-sm text-zinc-400 mb-1">AI Coding Assistant</p>
            <p class="text-xs text-zinc-600 max-w-xs mx-auto">Ask about Python, NumPy, SciPy, Matplotlib, or get help with your notebook code. Switch between <span class="text-amber-500/70">Claude</span> and <span class="text-blue-400/70">Gemini</span> using the dropdown above.</p>
        </div>
    </div>

    <!-- Input Area -->
    <div class="px-4 py-3 border-t border-zinc-800 shrink-0">
        <div id="ai-context-bar" class="hidden mb-2 flex items-center gap-2 bg-zinc-800/60 border border-zinc-700/50 rounded-lg px-3 py-1.5">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            <span id="ai-context-label" class="text-xs font-mono text-zinc-400 flex-1 truncate"></span>
            <button onclick="clearAiContext()" class="text-zinc-500 hover:text-zinc-300 transition-colors">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="flex gap-2">
            <textarea id="ai-input" rows="1" placeholder="Ask Claude about your code..."
                onkeydown="handleAiInputKey(event)" oninput="autoResizeAiInput(this)"
                class="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 text-sm font-mono px-3 py-2.5 rounded-lg outline-none focus:border-amber-500/50 placeholder-zinc-600 transition-colors resize-none max-h-32 overflow-y-auto"></textarea>
            <button onclick="sendAiMessage()" id="ai-send-btn" class="bg-amber-500 hover:bg-amber-400 disabled:bg-zinc-700 disabled:text-zinc-500 text-zinc-900 font-bold px-3 rounded-lg transition-colors shrink-0" title="Send message">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </div>
</aside>

<!-- ══════════════ STATUS BAR ══════════════ -->
<footer class="fixed bottom-0 left-0 right-0 bg-zinc-900 border-t border-zinc-800 px-4 py-1 z-40">
    <div class="max-w-6xl mx-auto flex items-center justify-between text-xs font-mono">
        <div class="flex items-center gap-3">
            <span id="kernel-status" class="flex items-center gap-1.5">
                <span id="kernel-dot" class="w-2 h-2 rounded-full bg-zinc-600"></span>
                <span id="kernel-label" class="text-zinc-500">Loading…</span>
            </span>
            <span class="text-zinc-700">│</span>
            <span id="cell-count" class="text-zinc-500">0 cells</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-zinc-600 hidden sm:inline">Shift+Enter: Run &amp; Advance</span>
            <span class="text-zinc-700 hidden sm:inline">│</span>
            <span class="text-zinc-600 hidden sm:inline">Ctrl+Enter: Run</span>
            <span class="text-zinc-700 hidden md:inline">│</span>
            <span class="text-zinc-500 hidden md:inline">NumPy · SciPy · Matplotlib</span>
        </div>
    </div>
</footer>

<!-- Hidden file input -->
<input type="file" id="file-input" accept=".json,.pylab" class="hidden" onchange="handleFileLoad(event)">

<!-- ══════════════ PYODIDE ══════════════ -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

<script>
// ═══════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════
let pyodide = null;
let cells = [];
let selectedCellId = null;
let execCount = 0;
let cellIdSeq = 0;
let kernelReady = false;
let kernelBusy = false;

// ═══════════════════════════════════════════
//  ICONS (inline SVG helpers)
// ═══════════════════════════════════════════
function svgIcon(paths, size = 16) {
    return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${paths}</svg>`;
}
const ICO = {
    play:      (s) => svgIcon('<polygon points="5 3 19 12 5 21 5 3"></polygon>', s),
    plus:      (s) => svgIcon('<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>', s),
    trash:     (s) => svgIcon('<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>', s),
    chevUp:    (s) => svgIcon('<polyline points="18 15 12 9 6 15"/>', s),
    chevDown:  (s) => svgIcon('<polyline points="6 9 12 15 18 9"/>', s),
    x:         (s) => svgIcon('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>', s),
    code:      (s) => svgIcon('<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>', s),
    type:      (s) => svgIcon('<polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/>', s),
};

// ═══════════════════════════════════════════
//  UTILITIES
// ═══════════════════════════════════════════
function genId() { return `cell-${++cellIdSeq}`; }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function idx(id) { return cells.findIndex(c => c.id === id); }
function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'fixed top-16 left-1/2 -translate-x-1/2 z-50 bg-zinc-800 border border-zinc-700 text-zinc-200 text-xs font-mono px-4 py-2 rounded-lg shadow-lg anim-fade-in';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.4s'; setTimeout(() => t.remove(), 400); }, 2200);
}

// ═══════════════════════════════════════════
//  CELL MANAGEMENT
// ═══════════════════════════════════════════
function createCell(type = 'code', content = '', afterIdx = cells.length - 1) {
    const cell = { id: genId(), type, content, executionCount: null, output: null, editor: null, isRunning: false, rendered: false };
    if (afterIdx < 0 && cells.length === 0) { cells.push(cell); }
    else { cells.splice(afterIdx + 1, 0, cell); }
    renderNotebook();
    selectCell(cell.id);
    return cell;
}

function deleteCell(id) {
    const i = idx(id);
    if (i === -1) return;
    cells.splice(i, 1);
    if (cells.length === 0) createCell('code', '', -1);
    else if (selectedCellId === id) selectCell(cells[Math.min(i, cells.length - 1)].id);
    else renderNotebook();
}

function moveCellDir(id, dir) {
    const i = idx(id);
    const ni = i + dir;
    if (ni < 0 || ni >= cells.length) return;
    [cells[i], cells[ni]] = [cells[ni], cells[i]];
    renderNotebook();
    selectCell(id);
}

function toggleCellType(id) {
    const cell = cells.find(c => c.id === id);
    if (!cell) return;
    if (cell.editor) { cell.content = cell.editor.getValue(); cell.editor = null; }
    cell.type = cell.type === 'code' ? 'markdown' : 'code';
    cell.rendered = false;
    cell.output = null;
    cell.executionCount = null;
    renderNotebook();
    selectCell(id);
}

function selectCell(id) {
    selectedCellId = id;
    document.querySelectorAll('.cell-wrap').forEach(el => {
        el.classList.toggle('border-l-amber-500', el.dataset.cellId === id);
        el.classList.toggle('border-l-zinc-800', el.dataset.cellId !== id);
    });
    const cell = cells.find(c => c.id === id);
    if (cell && cell.editor) setTimeout(() => cell.editor.focus(), 10);
}

function addCellAfter(afterIdx, type) { createCell(type, '', afterIdx); }

// ═══════════════════════════════════════════
//  RENDERING
// ═══════════════════════════════════════════
function renderNotebook() {
    // Persist editor contents before teardown
    cells.forEach(c => { if (c.editor) { c.content = c.editor.getValue(); c.editor = null; } });

    const nb = document.getElementById('notebook');
    nb.innerHTML = '';

    nb.appendChild(makeAddRow(-1));
    cells.forEach((cell, i) => {
        nb.appendChild(makeCellDOM(cell, i));
        nb.appendChild(makeAddRow(i));
    });

    // Init editors
    cells.forEach(c => initEditor(c));
    updateStatusBar();
}

function makeAddRow(afterIdx) {
    const row = document.createElement('div');
    row.className = 'add-row flex items-center justify-center gap-2';
    row.innerHTML = `
        <button onclick="addCellAfter(${afterIdx},'code')" class="text-zinc-600 hover:text-amber-400 hover:bg-zinc-800/60 px-2.5 py-0.5 rounded text-xs font-mono flex items-center gap-1 transition-colors">${ICO.plus(10)} Code</button>
        <button onclick="addCellAfter(${afterIdx},'markdown')" class="text-zinc-600 hover:text-amber-400 hover:bg-zinc-800/60 px-2.5 py-0.5 rounded text-xs font-mono flex items-center gap-1 transition-colors">${ICO.type(10)} Markdown</button>`;
    return row;
}

function makeCellDOM(cell) {
    const isSelected = cell.id === selectedCellId;
    const wrap = document.createElement('div');
    wrap.className = `cell-wrap anim-fade-in border-l-2 ${isSelected ? 'border-l-amber-500' : 'border-l-zinc-800'} bg-zinc-900 rounded-lg overflow-hidden group transition-all duration-200`;
    wrap.dataset.cellId = cell.id;

    const execLabel = cell.type === 'code'
        ? `In [${cell.executionCount ?? ' '}]:`
        : 'Md';

    const runBtnClass = cell.isRunning
        ? 'text-blue-400'
        : 'text-zinc-500 hover:text-amber-400 hover:bg-zinc-800';

    // ── Toolbar
    let toolbar = `
    <div class="flex items-center justify-between px-3 py-1.5 border-b border-zinc-800/60">
        <div class="flex items-center gap-2">
            <span class="font-mono text-xs ${cell.isRunning ? 'text-blue-400' : 'text-zinc-600'}">${esc(execLabel)}</span>
            ${cell.isRunning ? '<span class="inline-block w-3 h-3 border-2 border-blue-400 border-t-transparent rounded-full anim-spin"></span>' : ''}
        </div>
        <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition-opacity">
            <button onclick="runCell('${cell.id}')" class="${runBtnClass} px-2 py-1 rounded text-xs font-mono flex items-center gap-1 transition-colors" title="Run (Shift+Enter)">${ICO.play(12)} Run</button>
            <button onclick="moveCellDir('${cell.id}',-1)" class="text-zinc-500 hover:text-amber-400 hover:bg-zinc-800 p-1 rounded transition-colors" title="Move Up">${ICO.chevUp(14)}</button>
            <button onclick="moveCellDir('${cell.id}',1)" class="text-zinc-500 hover:text-amber-400 hover:bg-zinc-800 p-1 rounded transition-colors" title="Move Down">${ICO.chevDown(14)}</button>
            <button onclick="askAiAboutCell('${cell.id}')" class="text-zinc-500 hover:text-amber-400 hover:bg-zinc-800 px-1.5 py-1 rounded text-xs font-mono transition-colors flex items-center gap-0.5" title="Ask Claude about this cell">${svgIcon('<path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/><circle cx="9" cy="14" r="1"/><circle cx="15" cy="14" r="1"/>', 12)} AI</button>
            <button onclick="toggleCellType('${cell.id}')" class="text-zinc-500 hover:text-amber-400 hover:bg-zinc-800 p-1 rounded text-xs font-mono transition-colors" title="Toggle Code/Markdown">${cell.type === 'code' ? ICO.code(14) : ICO.type(14)}</button>
            <button onclick="deleteCell('${cell.id}')" class="text-zinc-500 hover:text-red-400 hover:bg-zinc-800 p-1 rounded transition-colors" title="Delete Cell">${ICO.x(14)}</button>
        </div>
    </div>`;

    // ── Editor / rendered markdown
    let editorArea;
    if (cell.type === 'markdown' && cell.rendered) {
        editorArea = `<div class="md-rendered px-4 py-3 cursor-pointer min-h-[2.5rem]" ondblclick="unrenderMarkdown('${cell.id}')">${marked.parse(cell.content || '*empty*')}</div>`;
    } else {
        editorArea = `<div class="cell-editor-area"><textarea id="editor-${cell.id}">${esc(cell.content)}</textarea></div>`;
    }

    // ── Output
    let outputArea = '';
    if (cell.output) {
        const o = cell.output;
        let parts = [];

        if (o.stdout) parts.push(`<pre class="font-mono text-sm text-zinc-300 whitespace-pre-wrap">${esc(o.stdout)}</pre>`);
        if (o.result) parts.push(`<pre class="font-mono text-sm text-zinc-100 whitespace-pre-wrap">${esc(o.result)}</pre>`);
        if (o.figures && o.figures.length) {
            o.figures.forEach(f => parts.push(`<img src="data:image/png;base64,${f}" class="max-w-full rounded-lg my-1">`));
        }
        if (o.stderr) parts.push(`<pre class="font-mono text-xs text-yellow-400/80 whitespace-pre-wrap">${esc(o.stderr)}</pre>`);
        if (o.error) parts.push(`<pre class="font-mono text-sm text-red-400 whitespace-pre-wrap bg-red-500/10 rounded-lg p-3">${esc(o.error)}</pre>`);

        if (parts.length) {
            outputArea = `
            <div class="border-t border-zinc-800/60 px-4 py-3 cell-output-scroll">
                ${cell.type === 'code' && cell.executionCount ? `<span class="font-mono text-xs text-zinc-600 block mb-1.5">Out [${cell.executionCount}]:</span>` : ''}
                <div class="flex flex-col gap-2">${parts.join('')}</div>
            </div>`;
        }
    }

    wrap.innerHTML = toolbar + editorArea + outputArea;

    // Click to select
    wrap.addEventListener('mousedown', (e) => {
        if (!e.target.closest('button')) selectCell(cell.id);
    });

    return wrap;
}

function initEditor(cell) {
    if (cell.type === 'markdown' && cell.rendered) return;
    const ta = document.getElementById(`editor-${cell.id}`);
    if (!ta) return;

    const mode = cell.type === 'code' ? 'python' : 'markdown';
    cell.editor = CodeMirror.fromTextArea(ta, {
        mode,
        lineNumbers: cell.type === 'code',
        matchBrackets: cell.type === 'code',
        autoCloseBrackets: cell.type === 'code',
        styleActiveLine: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: cell.type === 'markdown',
        viewportMargin: Infinity,
        extraKeys: {
            'Shift-Enter': () => runCellAndAdvance(cell.id),
            'Ctrl-Enter': () => runCell(cell.id),
            'Cmd-Enter': () => runCell(cell.id),
            'Ctrl-/': 'toggleComment',
            'Cmd-/': 'toggleComment',
            'Tab': (cm) => {
                if (cm.somethingSelected()) cm.indentSelection('add');
                else cm.replaceSelection('    ', 'end');
            }
        }
    });
    cell.editor.on('focus', () => selectCell(cell.id));
}

function unrenderMarkdown(id) {
    const cell = cells.find(c => c.id === id);
    if (!cell) return;
    cell.rendered = false;
    renderNotebook();
    selectCell(id);
}

function updateStatusBar() {
    const dot = document.getElementById('kernel-dot');
    const label = document.getElementById('kernel-label');
    const count = document.getElementById('cell-count');

    if (!kernelReady) {
        dot.className = 'w-2 h-2 rounded-full bg-zinc-600';
        label.textContent = 'Loading…';
        label.className = 'text-zinc-500';
    } else if (kernelBusy) {
        dot.className = 'w-2 h-2 rounded-full bg-blue-400 anim-spin';
        label.textContent = 'Busy';
        label.className = 'text-blue-400';
    } else {
        dot.className = 'w-2 h-2 rounded-full bg-green-400';
        label.textContent = 'Ready';
        label.className = 'text-green-400';
    }
    count.textContent = `${cells.length} cell${cells.length !== 1 ? 's' : ''}`;
}

// ═══════════════════════════════════════════
//  EXECUTION
// ═══════════════════════════════════════════
async function initPyodide() {
    try {
        updateLoading(5, 'Loading Pyodide runtime…');
        pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/' });

        updateLoading(20, 'Loading NumPy…');
        await pyodide.loadPackage('numpy');

        updateLoading(40, 'Loading Matplotlib…');
        await pyodide.loadPackage('matplotlib');

        updateLoading(60, 'Loading SciPy…');
        await pyodide.loadPackage('scipy');

        updateLoading(85, 'Configuring environment…');
        await pyodide.runPythonAsync(`
import matplotlib
matplotlib.use('agg')
import matplotlib.pyplot as plt
plt.style.use('dark_background')
plt.rcParams.update({
    'figure.facecolor': '#18181b',
    'axes.facecolor': '#27272a',
    'axes.edgecolor': '#3f3f46',
    'axes.labelcolor': '#a1a1aa',
    'text.color': '#f4f4f5',
    'xtick.color': '#71717a',
    'ytick.color': '#71717a',
    'grid.color': '#3f3f46',
    'grid.alpha': 0.3,
    'figure.figsize': [10, 5],
    'savefig.facecolor': '#18181b',
    'savefig.edgecolor': 'none',
    'font.size': 12,
})
import numpy as np
import scipy
`);

        kernelReady = true;
        updateLoading(100, 'Ready!');
        setTimeout(() => {
            document.getElementById('loading-screen').style.opacity = '0';
            document.getElementById('loading-screen').style.transition = 'opacity 0.5s';
            setTimeout(() => document.getElementById('loading-screen').classList.add('hidden'), 500);
        }, 400);
        updateStatusBar();
    } catch (err) {
        document.getElementById('loading-error').textContent = `Error: ${err.message}. Check your connection and refresh.`;
        document.getElementById('loading-error').classList.remove('hidden');
    }
}

function updateLoading(pct, msg) {
    document.getElementById('progress-fill').style.width = pct + '%';
    document.getElementById('loading-status').textContent = msg;
}

async function runCell(cellId) {
    const cell = cells.find(c => c.id === cellId);
    if (!cell) return;

    // Markdown cells: render and return
    if (cell.type === 'markdown') {
        if (cell.editor) { cell.content = cell.editor.getValue(); cell.editor = null; }
        cell.rendered = true;
        renderNotebook();
        return;
    }

    if (!kernelReady || kernelBusy) {
        showToast(kernelBusy ? 'Kernel is busy — wait for current cell to finish.' : 'Kernel is still loading…');
        return;
    }

    const code = cell.editor ? cell.editor.getValue() : cell.content;
    if (!code.trim()) return;

    // Save content
    if (cell.editor) cell.content = cell.editor.getValue();

    cell.isRunning = true;
    kernelBusy = true;
    execCount++;
    cell.executionCount = execCount;
    cell.output = null;
    refreshCellUI(cell);
    updateStatusBar();

    try {
        pyodide.globals.set('__user_code__', code);

        const raw = await pyodide.runPythonAsync(`
import sys as __sys, io as __io, json as __json, base64 as __b64, ast as __ast, traceback as __tb

__out = __io.StringIO()
__err = __io.StringIO()
__o_stdout = __sys.stdout
__o_stderr = __sys.stderr
__sys.stdout = __out
__sys.stderr = __err

__xerr = None
__xres = None

try:
    __tree = __ast.parse(__user_code__)
    if __tree.body and isinstance(__tree.body[-1], __ast.Expr):
        __last = __ast.Expression(__tree.body[-1].value)
        __ast.copy_location(__last, __tree.body[-1])
        __mod = __ast.Module(body=__tree.body[:-1], type_ignores=[])
        exec(compile(__mod, '<cell>', 'exec'), globals())
        __xval = eval(compile(__last, '<cell>', 'eval'), globals())
        if __xval is not None:
            __xres = repr(__xval)
    else:
        exec(compile(__tree, '<cell>', 'exec'), globals())
except:
    __xerr = __tb.format_exc()
finally:
    __sys.stdout = __o_stdout
    __sys.stderr = __o_stderr

__figs = []
try:
    import matplotlib.pyplot as __plt
    for __fn in __plt.get_fignums():
        __fig = __plt.figure(__fn)
        __buf = __io.BytesIO()
        __fig.savefig(__buf, format='png', dpi=150, bbox_inches='tight',
                      facecolor='#18181b', edgecolor='none')
        __buf.seek(0)
        __figs.append(__b64.b64encode(__buf.read()).decode())
    __plt.close('all')
except:
    pass

__json.dumps({'stdout': __out.getvalue(), 'stderr': __err.getvalue(), 'error': __xerr, 'result': __xres, 'figures': __figs})
`);
        cell.output = JSON.parse(raw);
    } catch (err) {
        cell.output = { stdout: '', stderr: '', error: err.message, result: null, figures: [] };
    }

    cell.isRunning = false;
    kernelBusy = false;
    refreshCellUI(cell);
    updateStatusBar();
}

function refreshCellUI(cell) {
    // Re-render just this cell (lightweight)
    const wrap = document.querySelector(`.cell-wrap[data-cell-id="${cell.id}"]`);
    if (!wrap) return;

    // Save cursor position
    let cursorPos = null;
    if (cell.editor) {
        cursorPos = cell.editor.getCursor();
        cell.content = cell.editor.getValue();
        cell.editor = null;
    }

    const newWrap = makeCellDOM(cell);
    wrap.replaceWith(newWrap);
    initEditor(cell);

    if (cursorPos && cell.editor) {
        cell.editor.setCursor(cursorPos);
        cell.editor.focus();
    }
    updateStatusBar();
}

async function runCellAndAdvance(cellId) {
    await runCell(cellId);
    const i = idx(cellId);
    if (i < cells.length - 1) {
        selectCell(cells[i + 1].id);
    } else {
        createCell('code', '', i);
    }
}

async function runAllCells() {
    for (const cell of cells) {
        if (cell.type === 'code' || cell.type === 'markdown') {
            await runCell(cell.id);
        }
    }
    showToast('All cells executed');
}

async function restartKernel() {
    if (!kernelReady) return;
    kernelReady = false;
    kernelBusy = false;
    execCount = 0;
    updateStatusBar();

    // Reset all execution counts and outputs
    cells.forEach(c => { c.executionCount = null; c.output = null; c.isRunning = false; });
    renderNotebook();

    try {
        // Re-initialize Python environment
        await pyodide.runPythonAsync(`
import importlib, sys
# Clear user-defined modules from sys.modules is tricky; we just reset the namespace
for _k in list(globals().keys()):
    if not _k.startswith('__'):
        try:
            del globals()[_k]
        except:
            pass

import matplotlib
matplotlib.use('agg')
import matplotlib.pyplot as plt
plt.style.use('dark_background')
plt.rcParams.update({
    'figure.facecolor': '#18181b',
    'axes.facecolor': '#27272a',
    'axes.edgecolor': '#3f3f46',
    'axes.labelcolor': '#a1a1aa',
    'text.color': '#f4f4f5',
    'xtick.color': '#71717a',
    'ytick.color': '#71717a',
    'grid.color': '#3f3f46',
    'grid.alpha': 0.3,
    'figure.figsize': [10, 5],
    'savefig.facecolor': '#18181b',
    'savefig.edgecolor': 'none',
    'font.size': 12,
})
import numpy as np
import scipy
`);
        kernelReady = true;
        updateStatusBar();
        showToast('Kernel restarted');
    } catch (err) {
        showToast('Restart failed: ' + err.message);
    }
}

function clearAllOutputs() {
    cells.forEach(c => { c.output = null; c.executionCount = null; });
    execCount = 0;
    renderNotebook();
    showToast('Outputs cleared');
}

// ═══════════════════════════════════════════
//  CHEAT SHEET PANEL
// ═══════════════════════════════════════════
function toggleCheatSheet() {
    const panel = document.getElementById('cheatsheet-panel');
    const overlay = document.getElementById('cheatsheet-overlay');
    const isOpen = panel.classList.contains('open');
    if (isOpen) {
        panel.classList.remove('open');
        overlay.classList.add('hidden');
    } else {
        panel.classList.add('open');
        overlay.classList.remove('hidden');
        document.getElementById('cheatsheet-search').value = '';
        filterCheatSheet('');
        document.getElementById('cheatsheet-search').focus();
    }
}

function filterCheatSheet(query) {
    const q = query.toLowerCase().trim();
    const sections = document.querySelectorAll('.cs-section');
    sections.forEach(section => {
        const rows = section.querySelectorAll('tbody tr');
        let anyVisible = false;
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const match = !q || text.includes(q);
            row.style.display = match ? '' : 'none';
            if (match) anyVisible = true;
        });
        section.classList.toggle('hidden', !anyVisible && !!q);
    });
}

// ═══════════════════════════════════════════
//  AI ASSISTANT
// ═══════════════════════════════════════════
let aiMessages = [];
let aiStreaming = false;
let aiContextCode = null;
let aiContextError = null;
let aiAbortController = null;
let aiProvider = localStorage.getItem('pylab-ai-provider') || 'claude';

const AI_SYSTEM_PROMPT = `You are an AI coding assistant embedded in PyLab, a browser-based Python notebook (like Jupyter) powered by Pyodide. The environment has NumPy, SciPy, and Matplotlib pre-loaded.

Key context:
- numpy is imported as np, scipy is available, matplotlib.pyplot is imported as plt
- Code runs in Pyodide (WebAssembly Python) — no filesystem, no network, no pip install beyond what Pyodide supports
- Plots use plt.show() and render inline as PNG
- Dark theme: background #18181b, accent #f59e0b (amber)

Guidelines:
- Give concise, practical answers with code examples
- When showing code, make it ready to paste and run in a notebook cell
- If the user shares cell code or errors, focus on their specific issue
- Use markdown formatting for clarity`;

function switchAiProvider(provider) {
    aiProvider = provider;
    localStorage.setItem('pylab-ai-provider', provider);
    const icon = document.getElementById('ai-provider-icon');
    if (provider === 'gemini') {
        icon.className = 'w-6 h-6 rounded-md bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center';
        icon.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`;
    } else {
        icon.className = 'w-6 h-6 rounded-md bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center';
        icon.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/><circle cx="9" cy="14" r="1"/><circle cx="15" cy="14" r="1"/></svg>`;
    }
    document.getElementById('ai-input').placeholder = provider === 'gemini'
        ? 'Ask Gemini about your code...'
        : 'Ask Claude about your code...';
}

function toggleAssistant() {
    const panel = document.getElementById('assistant-panel');
    const overlay = document.getElementById('assistant-overlay');
    const isOpen = panel.classList.contains('open');
    if (isOpen) {
        panel.classList.remove('open');
        overlay.classList.add('hidden');
    } else {
        panel.classList.add('open');
        overlay.classList.remove('hidden');
        // Restore provider selection
        document.getElementById('ai-provider-select').value = aiProvider;
        switchAiProvider(aiProvider);
        // Load saved API keys
        document.getElementById('ai-api-key-claude').value = localStorage.getItem('pylab-anthropic-key') || '';
        document.getElementById('ai-api-key-gemini').value = localStorage.getItem('pylab-gemini-key') || '';
        // Show settings if current provider has no key
        const currentKey = aiProvider === 'gemini'
            ? localStorage.getItem('pylab-gemini-key')
            : localStorage.getItem('pylab-anthropic-key');
        if (!currentKey) {
            document.getElementById('ai-settings').classList.remove('hidden');
        }
        setTimeout(() => document.getElementById('ai-input').focus(), 100);
    }
}

function toggleAssistantSettings() {
    document.getElementById('ai-settings').classList.toggle('hidden');
}

function toggleKeyVisibility(inputId) {
    const inp = document.getElementById(inputId);
    inp.type = inp.type === 'password' ? 'text' : 'password';
}

function saveProviderKey(provider, val) {
    const key = provider === 'gemini' ? 'pylab-gemini-key' : 'pylab-anthropic-key';
    localStorage.setItem(key, val.trim());
}

function getProviderKey(provider) {
    const key = provider === 'gemini' ? 'pylab-gemini-key' : 'pylab-anthropic-key';
    return (localStorage.getItem(key) || '').trim();
}

function clearAssistantChat() {
    aiMessages = [];
    clearAiContext();
    const container = document.getElementById('ai-messages');
    container.innerHTML = `
        <div class="text-center py-8">
            <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/20 flex items-center justify-center">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/><circle cx="9" cy="14" r="1"/><circle cx="15" cy="14" r="1"/></svg>
            </div>
            <p class="text-sm text-zinc-400 mb-1">AI Coding Assistant</p>
            <p class="text-xs text-zinc-600 max-w-xs mx-auto">Ask about Python, NumPy, SciPy, Matplotlib, or get help with your notebook code.</p>
        </div>`;
}

function clearAiContext() {
    aiContextCode = null;
    aiContextError = null;
    document.getElementById('ai-context-bar').classList.add('hidden');
}

function askAiAboutCell(cellId) {
    const cell = cells.find(c => c.id === cellId);
    if (!cell) return;
    const code = cell.editor ? cell.editor.getValue() : cell.content;
    aiContextCode = code;
    aiContextError = cell.output && cell.output.error ? cell.output.error : null;

    // Open assistant panel
    const panel = document.getElementById('assistant-panel');
    if (!panel.classList.contains('open')) toggleAssistant();

    // Show context bar
    const bar = document.getElementById('ai-context-bar');
    const label = document.getElementById('ai-context-label');
    bar.classList.remove('hidden');
    const preview = code.split('\n')[0].substring(0, 50) + (code.length > 50 ? '...' : '');
    label.textContent = aiContextError ? `Cell code + error` : `Cell: ${preview}`;

    // Focus input with suggested prompt
    const input = document.getElementById('ai-input');
    if (aiContextError) {
        input.value = 'Help me fix this error';
    } else {
        input.value = '';
    }
    input.focus();
    autoResizeAiInput(input);
}

function handleAiInputKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAiMessage();
    }
}

function autoResizeAiInput(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 128) + 'px';
}

function addAiMessageToUI(role, content) {
    const container = document.getElementById('ai-messages');
    // Remove welcome if present
    const welcome = container.querySelector('.text-center');
    if (welcome) welcome.remove();

    const div = document.createElement('div');
    div.className = `ai-msg ai-msg-${role} anim-fade-in`;

    if (role === 'user') {
        div.textContent = content;
    } else {
        div.innerHTML = renderAiMarkdown(content);
    }
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div;
}

function renderAiMarkdown(text) {
    let html = marked.parse(text || '');
    // Add insert buttons to code blocks
    html = html.replace(/<pre><code(?: class="language-(\w+)")?>([\s\S]*?)<\/code><\/pre>/g,
        (match, lang, code) => {
            const decoded = code.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'");
            const escaped = decoded.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n');
            return `<pre><code${lang ? ` class="language-${lang}"` : ''}>${code}</code><button class="ai-code-insert-btn" onclick="insertAiCode('${escaped}')" title="Insert into new cell">Insert</button></pre>`;
        });
    return html;
}

function insertAiCode(code) {
    // Unescape
    const decoded = code.replace(/\\n/g, '\n').replace(/\\'/g, "'").replace(/\\\\/g, '\\');
    const selIdx = selectedCellId ? idx(selectedCellId) : cells.length - 1;
    createCell('code', decoded, selIdx);
    showToast('Code inserted into new cell');
}

async function sendAiMessage() {
    const input = document.getElementById('ai-input');
    const text = input.value.trim();
    if (!text || aiStreaming) return;

    const apiKey = getProviderKey(aiProvider);
    if (!apiKey) {
        document.getElementById('ai-settings').classList.remove('hidden');
        const providerName = aiProvider === 'gemini' ? 'Google (Gemini)' : 'Anthropic (Claude)';
        showToast(`Please enter your ${providerName} API key`);
        document.getElementById(aiProvider === 'gemini' ? 'ai-api-key-gemini' : 'ai-api-key-claude').focus();
        return;
    }

    // Build user message with context
    let userContent = text;
    if (aiContextCode) {
        userContent = text + '\n\n```python\n' + aiContextCode + '\n```';
        if (aiContextError) {
            userContent += '\n\nError output:\n```\n' + aiContextError + '\n```';
        }
    }

    // Show user message (display only the typed text)
    addAiMessageToUI('user', text + (aiContextCode ? '\n[attached cell code' + (aiContextError ? ' + error' : '') + ']' : ''));

    // Add to conversation
    aiMessages.push({ role: 'user', content: userContent });

    // Clear input and context
    input.value = '';
    autoResizeAiInput(input);
    clearAiContext();

    // Show typing indicator
    const container = document.getElementById('ai-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'ai-typing';
    typingDiv.className = 'flex items-center gap-1.5 px-2 py-2';
    const dotColor = aiProvider === 'gemini' ? 'bg-blue-400' : 'bg-amber-500';
    typingDiv.innerHTML = `
        <span class="ai-typing-dot w-1.5 h-1.5 rounded-full ${dotColor}"></span>
        <span class="ai-typing-dot w-1.5 h-1.5 rounded-full ${dotColor}"></span>
        <span class="ai-typing-dot w-1.5 h-1.5 rounded-full ${dotColor}"></span>`;
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;

    // Disable send
    aiStreaming = true;
    document.getElementById('ai-send-btn').disabled = true;

    try {
        aiAbortController = new AbortController();

        if (aiProvider === 'gemini') {
            await streamGemini(apiKey, container, typingDiv);
        } else {
            await streamClaude(apiKey, container, typingDiv);
        }
    } catch (err) {
        typingDiv.remove();
        if (err.name !== 'AbortError') {
            const errDiv = document.createElement('div');
            errDiv.className = 'ai-msg ai-msg-assistant anim-fade-in border-red-500/30 bg-red-500/5';
            errDiv.innerHTML = `<p class="text-red-400 text-xs font-mono">${esc(err.message)}</p>`;
            container.appendChild(errDiv);
            container.scrollTop = container.scrollHeight;
        }
    } finally {
        aiStreaming = false;
        aiAbortController = null;
        document.getElementById('ai-send-btn').disabled = false;
        document.getElementById('ai-input').focus();
    }
}

// ── Claude (Anthropic) streaming ──
async function streamClaude(apiKey, container, typingDiv) {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true',
        },
        body: JSON.stringify({
            model: 'claude-sonnet-4-5-20250929',
            max_tokens: 4096,
            system: AI_SYSTEM_PROMPT,
            messages: aiMessages.slice(-20),
            stream: true,
        }),
        signal: aiAbortController.signal,
    });

    if (!resp.ok) {
        const errBody = await resp.text();
        let errMsg = `Claude API error ${resp.status}`;
        try { errMsg = JSON.parse(errBody).error?.message || errMsg; } catch {}
        throw new Error(errMsg);
    }

    typingDiv.remove();
    let fullText = '';
    const msgDiv = addAiMessageToUI('assistant', '');
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';

        for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const data = line.slice(6);
            if (data === '[DONE]') continue;
            try {
                const evt = JSON.parse(data);
                if (evt.type === 'content_block_delta' && evt.delta?.text) {
                    fullText += evt.delta.text;
                    msgDiv.innerHTML = renderAiMarkdown(fullText);
                    container.scrollTop = container.scrollHeight;
                }
            } catch {}
        }
    }
    aiMessages.push({ role: 'assistant', content: fullText });
}

// ── Gemini (Google) streaming ──
async function streamGemini(apiKey, container, typingDiv) {
    // Convert conversation history to Gemini format
    const contents = aiMessages.slice(-20).map(m => ({
        role: m.role === 'assistant' ? 'model' : 'user',
        parts: [{ text: m.content }],
    }));

    const resp = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:streamGenerateContent?alt=sse&key=${apiKey}`,
        {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents,
                systemInstruction: { parts: [{ text: AI_SYSTEM_PROMPT }] },
                generationConfig: { maxOutputTokens: 4096 },
            }),
            signal: aiAbortController.signal,
        }
    );

    if (!resp.ok) {
        const errBody = await resp.text();
        let errMsg = `Gemini API error ${resp.status}`;
        try {
            const parsed = JSON.parse(errBody);
            errMsg = parsed.error?.message || parsed[0]?.error?.message || errMsg;
        } catch {}
        throw new Error(errMsg);
    }

    typingDiv.remove();
    let fullText = '';
    const msgDiv = addAiMessageToUI('assistant', '');
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';

        for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const data = line.slice(6);
            if (data === '[DONE]') continue;
            try {
                const evt = JSON.parse(data);
                const chunk = evt.candidates?.[0]?.content?.parts?.[0]?.text;
                if (chunk) {
                    fullText += chunk;
                    msgDiv.innerHTML = renderAiMarkdown(fullText);
                    container.scrollTop = container.scrollHeight;
                }
            } catch {}
        }
    }
    aiMessages.push({ role: 'assistant', content: fullText });
}

// ═══════════════════════════════════════════
//  NOTEBOOK SERIALIZATION
// ═══════════════════════════════════════════
function downloadNotebook() {
    cells.forEach(c => { if (c.editor) c.content = c.editor.getValue(); });
    const data = {
        version: 1,
        app: 'PyLab',
        cells: cells.map(c => ({
            type: c.type,
            content: c.content,
            executionCount: c.executionCount,
            output: c.output,
        }))
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `notebook-${new Date().toISOString().slice(0,10)}.pylab`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('Notebook downloaded');
}

function handleFileLoad(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.cells && Array.isArray(data.cells)) {
                cells = data.cells.map(c => ({
                    id: genId(),
                    type: c.type || 'code',
                    content: c.content || '',
                    executionCount: c.executionCount || null,
                    output: c.output || null,
                    editor: null,
                    isRunning: false,
                    rendered: c.type === 'markdown' && c.output !== null,
                }));
                selectedCellId = cells.length ? cells[0].id : null;
                renderNotebook();
                showToast('Notebook loaded');
            }
        } catch (err) {
            showToast('Failed to load notebook');
        }
    };
    reader.readAsText(file);
    evt.target.value = '';
}

// ═══════════════════════════════════════════
//  PWA MANIFEST
// ═══════════════════════════════════════════
(function setupManifest() {
    const icon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="96" fill="#09090b"/><rect x="16" y="16" width="480" height="480" rx="80" fill="#18181b" stroke="#3f3f46" stroke-width="2"/><text x="256" y="340" font-family="monospace" font-size="280" font-weight="bold" fill="#f59e0b" text-anchor="middle">λ</text></svg>`;
    const manifest = {
        name: 'PyLab — Browser Python Notebook',
        short_name: 'PyLab',
        description: 'Jupyter-like notebook with NumPy, SciPy & Matplotlib in the browser',
        start_url: '.',
        display: 'standalone',
        background_color: '#09090b',
        theme_color: '#09090b',
        icons: [{ src: `data:image/svg+xml,${encodeURIComponent(icon)}`, sizes: 'any', type: 'image/svg+xml' }]
    };
    const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    document.getElementById('manifest-link').href = URL.createObjectURL(blob);
})();

// ═══════════════════════════════════════════
//  DEFAULT CONTENT
// ═══════════════════════════════════════════
const WELCOME_MD = `# Welcome to PyLab

A **browser-native** Python notebook powered by [Pyodide](https://pyodide.org). NumPy, SciPy, and Matplotlib are pre-loaded and ready to use.

**Shortcuts:** \`Shift+Enter\` to run & advance · \`Ctrl+Enter\` to run in place · Double-click rendered Markdown to edit`;

const DEMO_CODE = `import numpy as np
import matplotlib.pyplot as plt
from scipy import signal

# Generate a composite signal
t = np.linspace(0, 1, 500, endpoint=False)
x = np.sin(2 * np.pi * 5 * t) + 0.5 * np.sin(2 * np.pi * 12 * t)

# Low-pass Butterworth filter
b, a = signal.butter(4, 8, fs=500)
filtered = signal.filtfilt(b, a, x)

# Plot
fig, ax = plt.subplots(figsize=(10, 4))
ax.plot(t, x, alpha=0.5, label='Original', color='#f59e0b')
ax.plot(t, filtered, label='Filtered (8 Hz cutoff)', color='#4ade80', linewidth=2)
ax.fill_between(t, x, filtered, alpha=0.08, color='#f59e0b')
ax.set_xlabel('Time (s)')
ax.set_ylabel('Amplitude')
ax.set_title('Signal Filtering with SciPy', fontsize=14, fontweight='bold')
ax.legend(framealpha=0.3)
ax.grid(True, alpha=0.2)
plt.tight_layout()
plt.show()`;

const DEMO_CODE_2 = `# Quick NumPy demo
A = np.random.randn(3, 3)
eigenvalues, eigenvectors = np.linalg.eig(A)

print("Random matrix A:")
print(np.round(A, 3))
print("\\nEigenvalues:", np.round(eigenvalues, 3))
print("\\nDeterminant:", round(np.linalg.det(A), 4))`;

// ═══════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════
(async function main() {
    // Populate default cells
    createCell('markdown', WELCOME_MD, -1);
    cells[0].rendered = true;  // render the welcome markdown
    createCell('code', DEMO_CODE, 0);
    createCell('code', DEMO_CODE_2, 1);
    selectedCellId = cells[1].id;
    renderNotebook();

    // Boot Pyodide
    await initPyodide();
})();
</script>
</body>
</html>

